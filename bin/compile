#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

# fail fast
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

DOWNLOAD_DIR=$CACHE_DIR/poppler
TARGET_DIR=$BUILD_DIR/vendor/poppler

function indent() {
  sed -u 's/^/       /'
}

function topic() {
  echo "-----> $*"
}

mkdir -p $DOWNLOAD_DIR
cd $DOWNLOAD_DIR

topic "Downloading poppler source"
wget https://poppler.freedesktop.org/poppler-0.38.0.tar.xz | indent
tar -xf poppler-0.38.0.tar.xz | indent

topic "Building poppler"
cd poppler-0.38.0
./configure --prefix=$TARGET_DIR | indent
make | indent
make install | indent

export PKG_CONFIG_PATH=$TARGET_DIR/lib/pkgconfig

export | grep -E -e ' (PKG_CONFIG_PATH)=' > $BUILDPACK_DIR/export
